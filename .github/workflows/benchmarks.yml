name: Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'js-bindings/**'
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: js-bindings
        run: bun install

      - name: Run benchmarks
        working-directory: js-bindings
        run: bun run benchmarks/benchmark-json.ts

      - name: Generate charts
        working-directory: js-bindings
        run: bun run benchmarks/generate-charts.ts

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            js-bindings/benchmark-results.json
            js-bindings/charts/

      - name: Commit charts to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Copy charts to docs folder
          mkdir -p docs/benchmarks
          cp js-bindings/charts/*.png docs/benchmarks/
          cp js-bindings/benchmark-results.json docs/benchmarks/

          # Check if there are changes
          git add docs/benchmarks/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update benchmark charts [skip ci]"
            git push
          fi
